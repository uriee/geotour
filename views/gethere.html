<!DOCTYPE html>
<html lang="en">
  <head>
    <base href="/" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>GeThere</title>
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="bootstrap.min.css" Content-Type='text/css' rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="styles.css" rel="stylesheet">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

var socket = io();      
var rendererOptions = {
  draggable: false
};
var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);;
var directionsService = new google.maps.DirectionsService();
var map;



function initGeolocation() {
  if (navigator && navigator.geolocation) {
  var getp = navigator.geolocation.getCurrentPosition(initialize);  
  /*var watchId = navigator.geolocation.watchPosition(initialize, 
                                                  errorCallback,
                                                  {enableHighAccuracy:false,timeout:60000,maximumAge:60000});
                                                  */

  } else {
      console.log('Geolocation is not supported');
  }
}
      
  
      
  function start(){
    initGeolocation();
    setInterval(initGeolocation,60000)
    setInterval(function(){
      socket.emit('time',JSON.stringify({tour : '<%= tourname %>'}));
    },60000);
    $('#timer').text( '<%= H %>'+':'+'<%= M %>');
  };
      
 function errorCallback() {console.log("error with navigator object");}
      
function initialize(position) {
  var Current = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
  var Target = new google.maps.LatLng(<%= lng %>,<%= lat %>);
  var mapOptions = {
    zoom: 7,
    center: Current
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById('directionsPanel'));

  calcRoute(Current,Target);
}

function calcRoute(p1,p2) {

  var request = {
    origin: p1,
    destination: p2,
    travelMode: google.maps.TravelMode.WALKING
  };
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });
}

function computeTotalDistance(result) {
  var total = 0;
  var myroute = result.routes[0];
  for (var i = 0; i < myroute.legs.length; i++) {
    total += myroute.legs[i].distance.value;
  }
  total = total / 1000.0;
  document.getElementById('total').innerHTML = total + ' km';
}  
</script>  
  </head>
   <body  onload="javascript:start()">  
    <div class="container">
      <div class="row clearfix">
        <div class="col-md-12 column">
          <div class="row clearfix">
            <div class="col-sm-6 column">
              <button type="button" id='refresh' class="btn btn-primary">Refresh</button>
            </div>
            <div class="col-sm-6 column">
              <h3 id = 'timer' class="text-muted text-center">
                timer
              </h3>
            </div>
          </div>
          <div class="row clearfix">
            <div class="col-md-12 column">
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">
                Panel title
              </h3>
            </div>
            <div class="panel-body">
              <div  id="map-canvas" style="height:40%;top:70px"> </div
            </div>
            <div id="directionsPanel" style="top:1070px" class="panel-footer">
               <p>Total Distance: <span id="total"></span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
 <script>
  
  socket.on('time',function(data){
    data = JSON.parse(data);
    $('#timer').text( data.H+':'+data.M);
  })
  $("#refresh").on('click', function() {
    initGeolocation()
  });
  
</script>
  </body>
</html>